<html>
    <head>
        <title>Counterpoint.Elm</title>
    </head>
    <body>
    <div>WIP!!  Please see Counterpoint.js for what this will end up like. </div>
        <div id="main"></div>
        <script src="Main.js"></script>
        <script>
            var app = Elm.Main.fullscreen();

            app.ports.send.subscribe(play);

            var ctx = new window.webkitAudioContext || window.AudioContext;
            var i = 0 

           

            function play(args) {
                console.log(args);
                var note = args.noteList;
                var bpm = args.bpm;
                var osc = ctx.createOscillator();
                var gainNode = ctx.createGain();
                var hz = note[i].hz
                var octave = note[i].octave
                var sustain = note[i].duration; 
                var tempo = 60 / bpm * 0.5;
                var sustainFnl = sustain * tempo;

                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                gainNode.gain.value = 0.0;
                gainNode.gain.setTargetAtTime(0.75, ctx.currentTime, 0.1);
                gainNode.gain.setTargetAtTime(0.0, ctx.currentTime + sustainFnl, 0.01);
                osc.frequency.value = hz * octave / 4;
                osc.start();
                osc.stop(ctx.currentTime + sustainFnl + 0.01);
                console.log(i ,hz,sustain, octave);
                i++;

                if (note.length > i) {
                    setTimeout(function() {
                        play(args);
                    }, tempo * 1000 * note[i - 1].duration)
                }

                if (i === note.length)
                    i = 0;
            }
        </script>
    </body>
    
</html>
