<html>
<head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <title></title>
</head>
<body>
  <div class="container"></div>
  <h1>Music Maker</h1>
  <div>
    <select id="wav-type">
      <option value="sine">sine</option>
      <option value="triangle">triangle</option>
      <option value="square">square</option>
      <option selected="sawtooth" value="sawtooth">sawtooth</option>
    <input id="ns1">
    <input id="ns2">
    <input id="ns3">
    <input id="ns4">
    <button onclick="sendNotesToPlay(0, 'ns1'), sendNotesToPlay(0, 'ns2'), sendNotesToPlay(0, 'ns3'), sendNotesToPlay(0, 'ns4')">Push Play</button>
  </div>
  <ul>
    <li>Enter notes as "cw4"</li>
    <li>where "c" equals the note from a-g; #s work but no bs (that's flats, not BS)</li>
    <li>"w" equals rythmic note type; w for whole, h for half, q for quarter, o for eigth(
    it's complicated) s for sixteenth</li>
    <li>"4" equals the octave multiplier.  Any positive number works</li>
    <li>Enter "r" for rest.  Quarter note rest would be "rq3" (the last number must be there but can be any value).</li>
   </ul>
</body>
<script>

    var ctx = new window.webkitAudioContext || new window.AudioContext;
    
    //takes in formatted array, determines hertz, sustain, and octave, and sends to main play function 
    function sendNotesToPlay(index, id) {   
       var arr = stringParser(id);
       var octave = whichOctave(arr[index + 1][2]);
       var sustain = noteDuration(arr[index + 1][1]);
       var hertz = noteHz(arr[index + 1][0]);
        
        if (arr.length > index) {
        play(noteHz(arr[index][0]), noteDuration(arr[index][1]), whichOctave(arr[index][2]));

        setTimeout(function() {
          play(hertz, sustain, octave);
          sendNotesToPlay(++index, id);
        }, 1000 * noteDuration(arr[index][1]))
      }
    }
    
    //gets input string and formats it into array of arrays to send to sendNotesToPlay function
    function stringParser(id) {
      var noteString = document.getElementById(id).value.toLowerCase();  
      var noteArr =  noteString.match(/([a-g,r]+#|[a-g,r])([whqos])(\d)/g); 
      var finalArr = noteArr.map(makeArrInArr);

      function makeArrInArr(item) {
        if (item.length === 4) {
          var arr = [];
          arr.push(item.slice(0,2));
          arr.push(item.slice(2,3));
          arr.push(item.slice(3,4));
          return arr;
        } 
        
        if (item.length === 3) {
          var arr = [];
          arr.push(item.slice(0,1));
          arr.push(item.slice(1,2));
          arr.push(item.slice(2,3));
          return arr;
        }
      }
      return finalArr;
      // expected input ex: 'co1d#s4fw2', etc
      // expected output [[c,o,1],[d#,s,4],[f,w,2]], etc
    }
    
    //dertermines note duration
    function noteDuration(char) {
      var duration = char;
      var sustain;      
       if (duration === "w")
      sustain = 4
      
      if (duration === "h")
      sustain = 2
      
      if (duration === "q")
      sustain = 1
    
      if (duration === "o")
      sustain = .5
      
      if (duration === "s")
      sustain = .25
      
      return sustain;
    }
    
    //determines frequency
    function noteHz(note){
      var note = note;
      var frequencies = {
       	'c': 130.81,
       	'c#': 139.00,
       	'd': 146.83,
       	'd#': 156.00,
       	'e': 164.81,
       	'f': 174.61,
       	'f#': 185.00,
       	'g': 196.00,
       	'g#': 208.00,
       	'a': 220.00,
       	'a#': 233.00,
       	'b': 246.94,
       	'r': 0.0,
       	};
       	
       	var hertz = frequencies[note];
       	return hertz;
    }
    
    //determines octave number
    function whichOctave(num) {
      if (num === 1)
      return num;
      
      else
      return Math.pow(2, num -1);
            console.log(num);
    }
    
    //main sound generating function.  Receives attributes and creates appropriate note
    function play(hertz, sustain, octave) {
      var osc = ctx.createOscillator();
      var gainNode = ctx.createGain();
      
      osc.type = document.getElementById('wav-type').value;     
      osc.connect(gainNode);
      gainNode.connect(ctx.destination);
      gainNode.gain.value = 0.0;
      gainNode.gain.setTargetAtTime(.75, ctx.currentTime, 0.1);
      gainNode.gain.setTargetAtTime(0.0, ctx.currentTime + sustain, 0.01)
      osc.frequency.value = hertz * octave / 4;
      osc.start();
      osc.stop(ctx.currentTime + sustain + .01);
    }
    
</script>
</html>